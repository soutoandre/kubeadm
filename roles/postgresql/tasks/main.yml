---
- name: Install Packages from postgres Repo
  include: installsetup.yml
  when: installpostgre
  tags:
    - installpost


- name: Install Postgres
  yum: name={{ item }} state=present
  with_items:
    - postgresql{{ version_pkg }}-server
    - python-psycopg2

  tags:
    - postgresql

- name: Create data directory Postgressql
  file: path=/pgsql/{{ pg_version }}/data state=directory  owner=postgres group=postgres  
  
  tags:
    - postgresql

- name: Config PGSQL_HOME
  template: src=postgresqlenv.j2 dest=/etc/profile.d/postgresql.sh  owner=root group=root mode=0644
  tags:
    - postgresql

- name: Template service postgresql 
  template: src=postgresql.service.j2 dest=/usr/lib/systemd/system/postgresql-{{ pg_version }}.service 
  notify:  reload systemd
  tags:
    - postgresql

- name: Config pg_hba and postgresql
  template:  src={{ item }}.conf.j2  dest=/pgsql/{{ pg_version }}/data/{{ item }}.conf backup=yes owner=postgres group=postgres  mode=700
  with_items:
     - pg_hba
     - postgresql
  notify: restart postgresql-{{ pg_version }}

  tags:
    - postgresql

- name: set user postgres
  postgresql_user:  name=postgres password={{ postgres_pass }}  login_host=localhost login_user=postgres login_password={{ postgres_pass}}  state=present
  
  tags:
    - postgresql

